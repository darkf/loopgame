<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Loop</title>
<style>
	body { font-family: monospace; -webkit-user-select: none; cursor: default; }
	.tile { width: 1em; height: 1em; text-align: center; display: inline-block; }
</style>
<script>
"use strict";

const TILE_UP = 1;
const TILE_RIGHT = 2;
const TILE_DOWN = 4;
const TILE_LEFT = 8;

const board = [[9,  12, 12, 6]
              ,[10, 13, 13, 5]
              ,[3,  3,  9,  3]];

const solved = [[6, 12, 6, 12]
               ,[5, 7,  13, 5]
               ,[3, 9,  3, 9]];

function tileChar(tile) {
	switch(tile) {
		case TILE_UP | TILE_DOWN: return '┃';
		case TILE_LEFT | TILE_RIGHT: return '━';
		case TILE_DOWN | TILE_RIGHT: return '┏';
		case TILE_DOWN | TILE_LEFT: return '┓';
		case TILE_UP | TILE_LEFT: return '┛';
		case TILE_UP | TILE_RIGHT: return '┗';
		case TILE_UP | TILE_DOWN | TILE_RIGHT: return '┣';
		case TILE_LEFT | TILE_RIGHT | TILE_DOWN: return '┳';
		case TILE_LEFT | TILE_UP | TILE_DOWN: return '┫';
		case TILE_UP | TILE_LEFT | TILE_RIGHT: return '┻';
		case TILE_UP | TILE_DOWN | TILE_LEFT | TILE_RIGHT: return '╋';
		case TILE_UP: return '╹';
		case TILE_RIGHT: return '╺';
		case TILE_LEFT: return '╸';
		case TILE_DOWN: return '╻';
		default: throw new Error("");
	}
}

function rotate(tile) {
	let t = 0;

	if(tile & TILE_UP) t |= TILE_RIGHT;
	if(tile & TILE_DOWN) t |= TILE_LEFT;

	if(tile & TILE_LEFT) t |= TILE_UP;
	if(tile & TILE_RIGHT) t |= TILE_DOWN;

	console.log("tile: %d, t: %d", tile, t);

	return t;
}

// Is the graph described by the board connected? (i.e. are all edges connected?)
function isConnected(board) {
	function set(x, y, dir) {
		return (board[y] !== undefined && board[y][x] !== undefined) && (board[y][x] & dir);
	}

	for(let y = 0; y < board.length; y++) {
		for(let x = 0; x < board[y].length; x++) {
			const tile = board[y][x];

			if((tile & TILE_UP) && !set(x, y-1, TILE_DOWN)) return false;
			if((tile & TILE_DOWN) && !set(x, y+1, TILE_UP)) return false;
			if((tile & TILE_LEFT) && !set(x-1, y, TILE_RIGHT)) return false;
			if((tile & TILE_RIGHT) && !set(x+1, y, TILE_LEFT)) return false;
		}
	}

	return true;
}

function showBoard(board) {
	return board.map(row => row.map(tileChar).join('')).join('\n');
}

function solve(x, y) {
	if(y >= board.length || x >= board[0].length) {
		// console.log("is connected: ", isConnected(board))
		// console.log(showBoard(board));
		return isConnected(board);
	}

	for(let rotations = 0; rotations < 4; rotations++) {
		// Try solving the rest of the board, see if that configuration works
		if(x+1 === board[0].length) {
			if(solve(0, y+1))
				return true;
		}
		else if(solve(x+1, y))
			return true;

		board[y][x] = rotate(board[y][x]);
	}

	return false;
}

window.onload = function() {
	const game = document.getElementById("game");
	console.log("isConnected(board):", isConnected(board));
	console.log("isConnected(solved):", isConnected(solved));

	solve(0, 0);

	for(let y = 0; y < board.length; y++) {
		const rowEl = document.createElement("div");
		for(let x = 0; x < board[y].length; x++) {
			const cell = document.createElement("div");
			cell.className = "tile";
			cell.innerText = tileChar(board[y][x]);
			cell.onclick = function() {
				const tile = rotate(board[y][x]);
				board[y][x] = tile;
				this.innerText = tileChar(tile);

				if(isConnected(board))
					alert("Win!");
			};
			rowEl.appendChild(cell);
		}
		game.appendChild(rowEl);
	}

};
</script>
</head>
<body>
	<div id="game">
	</div>
</body>
</html>